<html>
<head>
   <meta charset="utf-8" />
   <script src="https://cdnjs.cloudflare.com/ajax/libs/custom-elements/1.1.1/custom-elements.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
   <script src="./app.js"></script>
  <style>
    /* you can style your program here */
  </style>
</head>
<body style="margin:60px;">
  <main></main>

  <script>
    var app = Elm.Main.embed(document.querySelector('main'))
    // you can use ports and stuff here
    // you can use ports and stuff here

    var typesetTimeout = null
    var typesetQueue = []
    function enqueueTypeset(el) {
      typesetQueue.push(el)
      clearTimeout(typesetTimeout)
      typesetTimeout = setTimeout(function () {
        var toTypeset = typesetQueue
        MathJax.Hub.Queue(['Typeset', MathJax.Hub, typesetQueue], function (arg) {
          toTypeset.forEach(function (el) { el.style.opacity = 1 })
        })
        typesetQueue = []
      }, 1)
    }

    var updateQueue = []
    var updateTimeout = null
    function enqueueUpdate(el) {
      updateQueue.push(el)
      clearTimeout(updateTimeout)
      updateTimeout = setTimeout(function () {
        MathJax.Hub.Queue(['Update', MathJax.Hub, updateQueue])
        updateQueue = []
      }, 0)
    }

    customElements.define('math-text', class extends HTMLElement {
      get content() {
        return this._content
      }

      set content(value) {
        if (this._content === value) return
        this._content = value
        console.log("SC: " + value)
        var jaxScript = this.querySelector('script')
        if (!jaxScript) return
        jaxScript.textContent = this._content
        enqueueUpdate(this)
      }

      connectedCallback() {
        this.textContent = '$$' + this._content + '$$'
        this._connected = true
        this.style.opacity = 0
        this.style.display = 'block'
        enqueueTypeset(this)
      }
    })
    
  </script>
</body>
</html>
